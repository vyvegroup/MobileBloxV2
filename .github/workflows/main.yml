name: Build MobileBloxV2

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        link-to-sdk: true
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build
        
    - name: Create CMakeLists.txt
      run: |
        cat > NativeLib/CMakeLists.txt << 'EOF'
cmake_minimum_required(VERSION 3.16)
project(MobileBloxV2)

set(CMAKE_CXX_STANDARD 17)

# Include directories
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/luau
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/luau/VM/include
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/luau/VM/src
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/luau/Common/include
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/luau/Ast/include
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/luau/Compiler/include
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/curl/include
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/cpr/include
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/dobby/include
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/imgui
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/ixwebsocket
    ${CMAKE_CURRENT_SOURCE_DIR}/dependencies/lz4/lib
)

# Luau source files
file(GLOB LUAU_VM_SRC 
    dependencies/luau/VM/src/*.cpp
)
file(GLOB LUAU_COMPILER_SRC 
    dependencies/luau/Compiler/src/*.cpp
)
file(GLOB LUAU_AST_SRC 
    dependencies/luau/Ast/src/*.cpp
)

# Main source files (exclude Luau since we include separately)
file(GLOB_RECURSE SOURCES 
    "*.cpp"
)

# Remove Luau files from main sources (will add separately)
list(FILTER SOURCES EXCLUDE REGEX "dependencies/luau/.*")

# Create shared library
add_library(mobileblox SHARED 
    ${SOURCES}
    ${LUAU_VM_SRC}
    ${LUAU_COMPILER_SRC}
    ${LUAU_AST_SRC}
)

# Add compile definitions
target_compile_definitions(mobileblox PRIVATE 
    ANDROID
    LUAU_FASTFLAG_LUAERRORRESPONSE
)

# Link libraries
find_library(log-lib log)
find_library(android-lib android)

target_link_libraries(mobileblox 
    ${log-lib}
    ${android-lib}
)
EOF
        
    - name: Build ARM32
      run: |
        cd NativeLib
        mkdir -p build && cd build
        cmake -G Ninja \
              -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=armeabi-v7a \
              -DANDROID_PLATFORM=android-21 \
              -DCMAKE_BUILD_TYPE=Release \
              ..
        ninja 2>&1 | tee build.log || {
          echo "=== Build failed, showing last 50 lines ==="
          tail -50 build.log
          exit 1
        }
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mobileblox-lib
        path: NativeLib/build/libmobileblox.so
        retention-days: 7
        
    - name: Upload build log
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-log
        path: NativeLib/build/build.log
        retention-days: 1
